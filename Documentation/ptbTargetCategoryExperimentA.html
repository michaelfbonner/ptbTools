
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>ptbTargetCategoryExperimentA</title><meta name="generator" content="MATLAB 8.5"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2015-04-16"><meta name="DC.source" content="ptbTargetCategoryExperimentA.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>ptbTargetCategoryExperimentA</h1><!--introduction--><p>Category-detection task for fMRI</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Syntax</a></li><li><a href="#2">Description</a></li><li><a href="#3">Example</a></li><li><a href="#4">See also</a></li><li><a href="#5">Function</a></li><li><a href="#7">Assign variables</a></li><li><a href="#8">Load scan sequence</a></li><li><a href="#9">Set experiment parameters</a></li><li><a href="#10">Display instructions</a></li><li><a href="#11">Pre-allocate output variables</a></li><li><a href="#12">Present stimuli</a></li><li><a href="#13">Save data</a></li><li><a href="#14">End session</a></li></ul></div><h2>Syntax<a name="1"></a></h2><p>ptbTargetCategoryExperimentA(SessionParameters)</p><h2>Description<a name="2"></a></h2><p>ptbTargetCategoryExperimentA implements an fMRI experiment for a target-category detection task. An image is displayed with an overlaid fixation crosshair for a set duration on each trial, and subjects indicate by button press when an image from a target category appears. The start of each trial is locked to a keyboard input of 't,' but this can be switched to a set trial duration by using the debugging mode. Null events are double nulls by default.  The script assumes that sequence files have been generated for each subject on each run and that these files fit a specified format (see below).</p><p>Although this function implements a general-purpose experimental protocol, there are a number of built-in settings that users might want to change. This function is provided mainly as an example experiment to illustrate the use of ptbTools and PsychToolbox. Keep in mind that all functions in ptbTools are in development and have not been tested. If you use this or any other ptbTools functions in your experiment, make sure to run validation tests to ensure that timing and accuracy measures are correct.</p><div><ul><li>SessionParameters.subjectNumber     - subject number (e.g., 1)</li><li>SessionParameters.runNumber     - run number (e.g., 1)</li><li>SessionParameters.isDebuggingRun    - logical value indicating whether this is a debugging run. 1 indicates debugging and uses timed trials (of length cTrialDuration). 0 indicates a real experiment and time-locks the start of each trial to a 't' keyboard input.</li><li>SessionParameters.isTransparentDisplay   - logical value indicating whether the display should be made semi-transparent, which can be helpfulf during debugging. 1 indicates a semi-transparent display. 0 indicates a real experiment and makes the dispay opaque. Transparency should only be used during debugging.</li><li>SessionParameters.directorySequences    - directory containg subject- and run-specific sequences. The file names should have the following format: 'subj001run001sequence.mat.' It is assumed that this file contains a SequenceInfo structure with the following fields:</li></ul></div><p>
<ul>
<ul style="list-style-type:circle">
<li>SequenceInfo.stimulusSequence   - a cell array of stimulus file names
for each trial, with 'null' entries for null trials</li>
<li>SequenceInfo.conditionSequence  - a cell array of of condition names,
which is used in selecting the stimulus-image directory and in
calculating accuracy</li>
<li>SequenceInfo.isTimeZero     - a sequence of logical values with a 1
indicating the time-zero trial. This trial is used as the reference point
when computing relative onset times. It should corresponds to the onset
of the first scan that you will model after removing dummy or start-up
scans.</li>
</ul>
</ul>
</p><div><ul><li>SessionParameters.StimulusDirectories   - this is the StimulusDirectories structure that will be passed to <a href="file:ptbFullfileByCondtion.html">ptbFullfileByCondtion</a></li><li>SessionParameters.directoryOutput   - directory that the experiment data will be saved to</li><li>SessionParameters.ResponseParameters   - this is the ResponseParameters structure that will be passed to <a href="file:ptbResponseAccuracy.html">ptbResponseAccuracy</a></li><li>SessionParameters.Timing    - a structure of timing information that must contain the following fields:</li></ul></div><p>
<ul>
<ul style="list-style-type:circle">
<li>Timing.cStimulusDuration    - amount of time (in seconds) that the
stimulus will be displayed</li>
<li>Timing.cTrialDuration    - amount of time (in seconds) per trial to use
in debugging mode</li>
</ul>
</ul>
</p><div><ul><li>SessionParameters.imageSize 	- size at which the stimulus images will be displayed. Note that if the actual images do not match this, they will be resized</li><li>SessionParameters.instructions 	- instructions that will be displayed at the start of the experiment (before the the first 't' input)</li></ul></div><p>A data file is saved to the output directory with the following format: subj001run001.mat. It is important to note that the relative onset times in this file are calculated relative to a user specified time-zero trial, which is assigned in the isTimeZero field of the SequenceInfo structure. Raw time stamps are also provided so that onset times can be recalculated in the event that the time-zero reference point needs to be changed. This file contains a ScanData structure with the following fields.</p><div><ul><li>ScanData.GeneralInfo.date   - date that experiment was run</li><li>ScanData.GeneralInfo.computer   - computer that expriment was run on</li><li>ScanData.GeneralInfo.subject    - subject name (e.g., 'subj001')</li><li>ScanData.GeneralInfo.run    - run name (e.g., 'run001')</li><li>ScanData.GeneralInfo.SessionParameters  - input parameters passed to this function</li><li>ScanData.Sequence   - the SequenceInfo structure loaded in for this subject and run</li><li>ScanData.Timing.TrialOnset.raw 	- time stamp of trial onset</li><li>ScanData.Timing.TrialOnset.relative 	- trial onset time relative to the time-zero reference point</li><li>ScanData.Timing.StimulusOnset.raw 	- time stamp of stimulus onset (this could lag behind the trial onset if the computer is slow or if the stimulus files a very large)</li><li>ScanData.Timing.StimulusOnset.relative 	- stimulus onset time relative to the time-zero reference point</li><li>ScanData.Timing.StimulusOffset.raw 	- time stamp of stimulus offset</li><li>ScanData.Timing.InterStimulusIntervalOnsets.raw 	- time stamp of ISI onset</li><li>ScanData.Timing.timeZeroTrial 	- trial number of the time-zero trial used as the zero reference point</li><li>ScanData.ResponseData.responses     - subject's responses</li><li>ScanData.ResponseData.accuracy     - subject's accuracy</li><li>ScanData.ResponseData.ReactionTime.raw     - time stamps of subject's responses</li><li>ScanData.ResponseData.ReactionTime.relative     - subject's reaction time relative to stimulus onset</li></ul></div><h2>Example<a name="3"></a></h2><pre class="language-matlab"><span class="comment">% Import default settings</span>
setPtbParameters_TargetCategory_v001;
isDebuggingRun = PtbParameters.isDebuggingRun;
isTransparentDisplay = PtbParameters.isTransparentDisplay;
</pre><pre class="language-matlab"><span class="comment">% Directories</span>
directorySequences = PtbParameters.directorySequences;
directoryStimuli = PtbParameters.directoryStimuli;
directoryOutput = PtbParameters.directoryOutput;
directoryExperimental = fullfile(directoryStimuli, <span class="string">'pathways'</span>);
directoryTarget = fullfile(directoryStimuli, <span class="string">'target'</span>);
directoryFiller = fullfile(directoryStimuli, <span class="string">'filler'</span>);
directoryStartUp = fullfile(directoryStimuli, <span class="string">'startUp'</span>);
</pre><pre class="language-matlab"><span class="comment">% Add ptbTools paths</span>
addpath(PtbParameters.directoryPtbTools);
</pre><pre class="language-matlab"><span class="comment">% Condition labels and associated directories (this will be passed to</span>
<span class="comment">% ptbFullfileByCondtion)</span>
StimulusDirectories.StartUp.conditions = {<span class="string">'startUp'</span>};
StimulusDirectories.StartUp.directory = directoryStartUp;
StimulusDirectories.Experimental.conditions = {<span class="string">'pathways'</span>, <span class="string">'targetCarryover'</span>, <span class="string">'fillerCarryover'</span>, <span class="string">'nullCarryover'</span>};
StimulusDirectories.Experimental.directory = directoryExperimental;
StimulusDirectories.Target.conditions = {<span class="string">'target'</span>};
StimulusDirectories.Target.directory = directoryTarget;
StimulusDirectories.Filler.conditions = {<span class="string">'filler'</span>};
StimulusDirectories.Filler.directory = directoryFiller;
StimulusDirectories.Null.conditions = {<span class="string">'null'</span>};
StimulusDirectories.Null.directory = [];
StimulusDirectories.WrapUp.conditions = {<span class="string">'wrapUp'</span>};
StimulusDirectories.WrapUp.directory = [];
</pre><pre class="language-matlab"><span class="comment">% Response keys and conditions</span>
<span class="keyword">if</span> isDebuggingRun
    rightKey = <span class="string">'m'</span>;
<span class="keyword">else</span>
    rightKey = <span class="string">'r'</span>;
<span class="keyword">end</span>
responseKeys = {rightKey};
rightConditionLabel = <span class="string">'target'</span>;
ResponseParameters.responseKeys = responseKeys;
ResponseParameters.rightKey = rightKey;
ResponseParameters.rightConditionLabel = rightConditionLabel;
ResponseParameters.leftKey = nan;
ResponseParameters.leftConditionLabel = nan;
</pre><pre class="language-matlab"><span class="comment">% Timing (in seconds)</span>
Timing.cStimulusDuration = 1.5;  <span class="comment">% seconds</span>
Timing.cTrialDuration = 2;  <span class="comment">% for debugging mode</span>
</pre><pre class="language-matlab"><span class="comment">% Screen size, which is used for sizing the stimulus</span>
hScreen = ptbScreenSettings;  <span class="comment">% screen settings, including a standard gray background</span>
screenSize = Screen(<span class="string">'Rect'</span>, hScreen);
screenHeight = screenSize(3);
</pre><pre class="language-matlab"><span class="comment">% Image size</span>
cImageDownsize = PtbParameters.cImageDownsize;
imageExtension = PtbParameters.imageExtension;
directoryExampleImage = fullfile(directoryStimuli, <span class="string">'pathways'</span>);
searchInput = fullfile(directoryExampleImage, [<span class="string">'*'</span> imageExtension]);
searchResults = dir(searchInput);
exampleImageFile = fullfile(directoryExampleImage, searchResults(1).name);
exampleImage = imread(exampleImageFile);
exampleImageSize = size(exampleImage);
exampleImageSize = exampleImageSize(1 : 2);
exampleImageHeight = exampleImageSize(1);
largestPossibleScaling = screenHeight / exampleImageHeight;
cImageScale = cImageDownsize * largestPossibleScaling;
imageSize = exampleImageSize * cImageScale;
clear <span class="string">exampleImage</span> <span class="string">searchInput</span> <span class="string">searchResults</span> <span class="string">directoryExampleImage</span>;
</pre><pre class="language-matlab"><span class="comment">% Instructions</span>
instructions = [
    <span class="string">'Please fixate on the crosshair and pay attention to each scene.\n\n'</span><span class="keyword">...</span>
    <span class="string">'Press the right button if the scene is a target scene.\n\n'</span><span class="keyword">...</span>
    <span class="string">'Get ready!\n\n'</span>
    ];
</pre><pre class="language-matlab"><span class="comment">% Run this session</span>
SessionParameters.subjectNumber = subjectNumber;
SessionParameters.runNumber = runNumber;
SessionParameters.isDebuggingRun = isDebuggingRun;
SessionParameters.isTransparentDisplay = isTransparentDisplay;
SessionParameters.directorySequences = directorySequences;
SessionParameters.StimulusDirectories = StimulusDirectories;
SessionParameters.directoryOutput = directoryOutput;
SessionParameters.ResponseParameters = ResponseParameters;
SessionParameters.Timing = Timing;
SessionParameters.imageSize = imageSize;
SessionParameters.instructions = instructions;
ptbTargetCategoryExperimentA(SessionParameters)
</pre><h2>See also<a name="4"></a></h2><div><ul><li><a href="file:ptbRunExperiment.html">ptbRunExperiment</a></li><li><a href="file:ptbFullfileByCondtion.html">ptbFullfileByCondtion</a></li><li><a href="file:ptbScreenSettings.html">ptbScreenSettings</a></li><li><a href="file:ptbInstructions.html">ptbInstructions</a></li><li><a href="file:ptbWaitForT.html">ptbWaitForT</a></li><li><a href="file:ptbKbQueueCreate.html">ptbKbQueueCreate</a></li><li><a href="file:ptbRelativeToTimeZero.html">ptbRelativeToTimeZero</a></li><li><a href="file:ptbGetResponse.html">ptbGetResponse</a></li><li><a href="file:ptbResponseAccuracy.html">ptbResponseAccuracy</a></li><li><a href="file:ptbCrosshair.html">ptbCrosshair</a></li><li><a href="file:ptbEndRun.html">ptbEndRun</a></li></ul></div><p>Michael F. Bonner | University of Pennsylvania | <a href="http://www.michaelfbonner.com">http://www.michaelfbonner.com</a></p><h2>Function<a name="5"></a></h2><pre class="codeinput"><span class="keyword">function</span> ptbTargetCategoryExperimentA(SessionParameters)
</pre><h2>Assign variables<a name="7"></a></h2><pre class="codeinput"><span class="comment">% SessionParameters inputs</span>
subjectNumber = SessionParameters.subjectNumber;
runNumber = SessionParameters.runNumber;
isDebuggingRun = SessionParameters.isDebuggingRun;
isTransparentDisplay = SessionParameters.isTransparentDisplay;
directorySequences = SessionParameters.directorySequences;
directoryOutput = SessionParameters.directoryOutput;
StimulusDirectories = SessionParameters.StimulusDirectories;
ResponseParameters = SessionParameters.ResponseParameters;
Timing = SessionParameters.Timing;
imageSize = SessionParameters.imageSize;
instructions = SessionParameters.instructions;
PtbParameters = SessionParameters.PtbParameters;

<span class="comment">% More input parsing</span>
responseKeys = ResponseParameters.responseKeys;
cStimulusDuration = Timing.cStimulusDuration;
cTrialDuration = Timing.cTrialDuration;

<span class="comment">% Subject and run</span>
subjectName = [<span class="string">'subj'</span> num2str(subjectNumber, <span class="string">'%03d'</span>)];
runName = [<span class="string">'run'</span> num2str(runNumber, <span class="string">'%03d'</span>)];

<span class="comment">% Output data file</span>
<span class="keyword">if</span> ~exist(directoryOutput, <span class="string">'dir'</span>);
    mkdir(directoryOutput);
<span class="keyword">end</span>
ScanDataFileName = [subjectName runName <span class="string">'data.mat'</span>];
ScanDataFullFile = fullfile(directoryOutput, ScanDataFileName);

<span class="comment">% Check that data has not already been generated for this subject and run</span>
<span class="keyword">if</span> exist(ScanDataFullFile, <span class="string">'file'</span>)
    error(<span class="string">'An output file has already been generated for this subject and run'</span>);
<span class="keyword">end</span>

<span class="comment">% Stimulus directories</span>
FullfileParameters.StimulusDirectories = StimulusDirectories;

<span class="comment">% Delay before displaying stimulus in debuggind mode</span>
cOnsetDelay = 0;
</pre><h2>Load scan sequence<a name="8"></a></h2><p>sequenceFullFile contains the SequenceInfo with the following fields:</p><div><ul><li>SequenceInfo.conditionSequence    - sequence of condition labels for this run</li><li>SequenceInfo.stimulusSequence   - sequence of stimulus files for this run</li><li>SequenceInfo.isTimeZero   - sequence of logical values in which the only 'true' entry is the first trial after the startUp trials (this represents time t=0 if the startUp scans are removed before analyzing the fMRI data)</li></ul></div><pre class="codeinput">sequenceFileName = [subjectName runName <span class="string">'sequence.mat'</span>];
sequenceFullFile = fullfile(directorySequences, sequenceFileName);
load(sequenceFullFile);  <span class="comment">% Loads SequenceInfo (described at the top of this code section)</span>
stimulusSequence = SequenceInfo.stimulusSequence;
conditionSequence = SequenceInfo.conditionSequence;
isTimeZeroValues = SequenceInfo.isTimeZero;
timeZeroTrial = find(isTimeZeroValues);
</pre><h2>Set experiment parameters<a name="9"></a></h2><pre class="codeinput"><span class="comment">% Make display transparent when debugging</span>
<span class="keyword">if</span> isTransparentDisplay
    screenOpacity = 0.75;
    PsychDebugWindowConfiguration(0, screenOpacity);  <span class="comment">% note that time-stamping will be inaccurate in this mode</span>
<span class="keyword">end</span>

<span class="comment">% Reseed the random-number generator</span>
rand(<span class="string">'state'</span>, sum(100 * clock));

<span class="comment">% PsychToolbox settings</span>
hScreen = ptbScreenSettings;  <span class="comment">% screen settings, including a standard gray background</span>
AssertOpenGL;  <span class="comment">% Check for OpenGL compatibility, abort otherwise</span>
KbName(<span class="string">'UnifyKeyNames'</span>); <span class="comment">% Make sure keyboard mapping is the same on all supported operating systems: Apple MacOS/X, MS-Windows and GNU/Linux:</span>

<span class="comment">% Position for center of screen</span>
screenSize = Screen(<span class="string">'Rect'</span>, hScreen);
screenWidth = screenSize(4);
screenHeight = screenSize(3);
centerWidth = screenWidth / 2;
centerHeight = screenHeight / 2;

<span class="comment">% Crosshair</span>
CrosshairParameters.color = [50 50 50];
CrosshairParameters.width = 20;
CrosshairParameters.height = 20;
CrosshairParameters.thickness = 6;
CrosshairParameters.screenCenterWidth = centerWidth;
CrosshairParameters.screenCenterHeight = centerHeight;
CrosshairParameters.screenHandle = hScreen;

<span class="comment">% Text properties</span>
Screen(<span class="string">'TextSize'</span>, hScreen, 32);
Screen(<span class="string">'TextFont'</span>, hScreen, <span class="string">'Arial'</span>);

<span class="comment">% Do dummy calls to make sure functions are loaded and ready when we need them - without delays:</span>
WaitSecs(0.1);
GetSecs;
</pre><h2>Display instructions<a name="10"></a></h2><pre class="codeinput">InstructionsParameters.instructions = instructions;
InstructionsParameters.screenHandle = hScreen;
InstructionsParameters.textColor = WhiteIndex(hScreen);
ptbInstructions(InstructionsParameters);

<span class="comment">% If in debugging moded, wait trial duration, instead of waiting for for</span>
<span class="comment">% the first 't' below</span>
<span class="keyword">if</span> isDebuggingRun
    WaitSecs(cTrialDuration);
<span class="keyword">end</span>
</pre><h2>Pre-allocate output variables<a name="11"></a></h2><p>Notes:</p><div><ul><li>Relative trial times are calculated relative to the 'isTimeZero' trial</li><li>Relative reaction times are calculated relative to the stimulus onset</li></ul></div><pre class="codeinput"><span class="comment">% Get number of events in loop</span>
nTrials = length(stimulusSequence);

<span class="comment">% Trial timing</span>
Timing.TrialOnset.raw = nan(nTrials, 1, <span class="string">'single'</span>);
Timing.TrialOnset.relative = nan(nTrials, 1, <span class="string">'single'</span>);
Timing.StimulusOnset.raw = nan(nTrials, 1, <span class="string">'single'</span>);
Timing.StimulusOnset.relative = nan(nTrials, 1, <span class="string">'single'</span>);
Timing.StimulusOffset.raw = nan(nTrials, 1, <span class="string">'single'</span>);
Timing.InterStimulusIntervalOnsets.raw = nan(nTrials, 1, <span class="string">'single'</span>);
Timing.timeZeroTrial = timeZeroTrial;

<span class="comment">% Response data</span>
ResponseData.responses = cell(nTrials, 1);
ResponseData.accuracy = nan(nTrials, 1, <span class="string">'single'</span>);
ResponseData.ReactionTime.raw = nan(nTrials, 1, <span class="string">'single'</span>);
ResponseData.ReactionTime.relative = nan(nTrials, 1, <span class="string">'single'</span>);
</pre><h2>Present stimuli<a name="12"></a></h2><pre class="codeinput">timeZero = [];
<span class="keyword">for</span> iTrials = 1 : nTrials

    <span class="comment">% Check for time-zero trial</span>
    isTimeZero = iTrials == timeZeroTrial;

    <span class="comment">% Condition and stimulus information</span>
    thisCondition = conditionSequence{iTrials};
    thisStimulusFile = stimulusSequence{iTrials};
    FullfileParameters.thisCondition = thisCondition;
    FullfileParameters.thisStimulusFile = thisStimulusFile;
    thisStimulusFullFile = ptbFullfileByCondtion(FullfileParameters);

    <span class="comment">% Condition-specific routines</span>
    <span class="keyword">if</span> strcmp(thisCondition, <span class="string">'null'</span>)

        <span class="comment">% Double null events</span>

        <span class="comment">% First null</span>
        WaitParameters.isDebuggingRun = isDebuggingRun;
        WaitParameters.isTimeZero = isTimeZero;
        WaitParameters.timeZero = timeZero;
        WaitParameters.cTrialDuration = cTrialDuration;  <span class="comment">% used only in debugging mode</span>
        WaitOutput = ptbWaitForT(WaitParameters);
        timeZero = WaitOutput.timeZero;
        thisTrialOnset = WaitOutput.thisTrialOnset;
        thisRelativeTrialOnset = WaitOutput.thisRelativeTrialOnset;

        <span class="comment">% Second null</span>
        WaitOutput = ptbWaitForT(WaitParameters);
        thisIsiOnset = WaitOutput.thisTrialOnset;

        <span class="comment">% Trial timing</span>
        Timing.TrialOnset.raw(iTrials) = thisTrialOnset;
        Timing.TrialOnset.relative(iTrials) = thisRelativeTrialOnset;
        Timing.InterStimulusIntervalOnsets.raw(iTrials) = thisIsiOnset;

    <span class="keyword">elseif</span> strcmp(thisCondition, <span class="string">'wrapUp'</span>)

        <span class="comment">% Wrap-up trials are single null events</span>

        <span class="comment">% Null</span>
        WaitParameters.isDebuggingRun = isDebuggingRun;
        WaitParameters.isTimeZero = isTimeZero;
        WaitParameters.timeZero = timeZero;
        WaitParameters.cTrialDuration = cTrialDuration;  <span class="comment">% used only in debugging mode</span>
        WaitOutput = ptbWaitForT(WaitParameters);
        timeZero = WaitOutput.timeZero;
        thisTrialOnset = WaitOutput.thisTrialOnset;
        thisRelativeTrialOnset = WaitOutput.thisRelativeTrialOnset;

        <span class="comment">% Trial timing</span>
        Timing.TrialOnset.raw(iTrials) = thisTrialOnset;
        Timing.TrialOnset.relative(iTrials) = thisRelativeTrialOnset;

    <span class="keyword">else</span>

        <span class="comment">% Stimulus trials:</span>
        <span class="comment">% * startUp</span>
        <span class="comment">% * pathways</span>
        <span class="comment">% * target</span>
        <span class="comment">% * filler</span>
        <span class="comment">% * targetCarryover</span>
        <span class="comment">% * fillerCarryover</span>
        <span class="comment">% * nullCarryover</span>

        <span class="comment">% Load stimulus image</span>
        thisImage = imread(thisStimulusFullFile);
        thisImage = imresize(thisImage, imageSize);
        thisImageScreenTexture = Screen(<span class="string">'MakeTexture'</span>, hScreen, thisImage);
        Screen(<span class="string">'DrawTexture'</span>, hScreen, thisImageScreenTexture);  <span class="comment">% Draw texture image to backbuffer.</span>

        <span class="comment">% Load crosshair on top of image</span>
        ptbCrosshair(CrosshairParameters);

        <span class="comment">% Wait for 't'</span>
        WaitParameters.isDebuggingRun = isDebuggingRun;
        WaitParameters.isTimeZero = isTimeZero;
        WaitParameters.timeZero = timeZero;
        WaitParameters.cTrialDuration = cOnsetDelay;  <span class="comment">% debugging mode: zero delay at this point</span>
        WaitOutput = ptbWaitForT(WaitParameters);
        timeZero = WaitOutput.timeZero;
        thisTrialOnset = WaitOutput.thisTrialOnset;
        thisRelativeTrialOnset = WaitOutput.thisRelativeTrialOnset;

        <span class="comment">% Create KbQueue for responses</span>
        ptbKbQueueCreate(responseKeys)
        KbQueueFlush(); <span class="comment">% removes all keyboard presses</span>

        <span class="comment">% Display stimulus</span>
        [~, thisStimulusOnset] = Screen(<span class="string">'Flip'</span>, hScreen);
        thisRelativeStimulusOnset = ptbRelativeToTimeZero(thisStimulusOnset, timeZero);

        <span class="comment">% Get key response while stimulus is up</span>
        [thisResponseKey, thisRawReactionTime, thisRelativeReactionTime] = ptbGetResponse(thisStimulusOnset, cStimulusDuration);

        <span class="comment">% Compute accuracy</span>
        thisTrialAccuracy = ptbResponseAccuracy(thisResponseKey, thisCondition, ResponseParameters);

        <span class="comment">% Display crosshair</span>
        Screen(<span class="string">'Close'</span>);
        ptbCrosshair(CrosshairParameters);
        [~, thisStimulusOffset] = Screen(<span class="string">'Flip'</span>, hScreen);

        <span class="comment">% Interstimulus interval (one 't')</span>
        IntervalParameters.thisTrialOnset = thisTrialOnset;
        IntervalParameters.isDebuggingRun = isDebuggingRun;
        IntervalParameters.isTimeZero = isTimeZero;
        IntervalParameters.timeZero = timeZero;
        IntervalParameters.cTrialDuration = cTrialDuration;  <span class="comment">% used only in debugging mode</span>
        IntervalOutput = ptbInterStimulusInterval(IntervalParameters);
        thisIsiOnset = IntervalOutput.WaitOutput.thisTrialOnset;

        <span class="comment">% Trial timing</span>
        Timing.TrialOnset.raw(iTrials) = thisTrialOnset;
        Timing.TrialOnset.relative(iTrials) = thisRelativeTrialOnset;
        Timing.StimulusOnset.raw(iTrials) = thisStimulusOnset;
        Timing.StimulusOnset.relative(iTrials) = thisRelativeStimulusOnset;
        Timing.StimulusOffset.raw(iTrials) = thisStimulusOffset;
        Timing.InterStimulusIntervalOnsets.raw(iTrials) = thisIsiOnset;

        <span class="comment">% Response data</span>
        ResponseData.responses{iTrials} = thisResponseKey;
        ResponseData.accuracy(iTrials) = thisTrialAccuracy;
        ResponseData.ReactionTime.raw(iTrials) = thisRawReactionTime;
        ResponseData.ReactionTime.relative(iTrials) = thisRelativeReactionTime;

    <span class="keyword">end</span>  <span class="comment">% if strcmp(thisCondition, 'null')</span>

    Screen(<span class="string">'Close'</span>);

<span class="keyword">end</span>  <span class="comment">% for iTrials = 1 : nTrials</span>
</pre><h2>Save data<a name="13"></a></h2><pre class="codeinput"><span class="comment">% General experiment information</span>
GeneralInfo.date = date;
GeneralInfo.computer = computer;
GeneralInfo.subject = subjectName;
GeneralInfo.run = runName;
GeneralInfo.SessionParameters = SessionParameters;

<span class="comment">% Save all data</span>
ScanData.General = GeneralInfo;
ScanData.Sequence = SequenceInfo;
ScanData.Timing = Timing;
ScanData.Responses = ResponseData;
save(ScanDataFullFile, <span class="string">'ScanData'</span>);
</pre><h2>End session<a name="14"></a></h2><pre class="codeinput">EndRunParameters.screenHandle = hScreen;
EndRunParameters.message = <span class="string">'Great job!'</span>;
EndRunParameters.textColor = WhiteIndex(hScreen);
ptbEndRun(EndRunParameters)
</pre><pre class="codeinput"><span class="keyword">end</span>  <span class="comment">% function pwExperimentTargetCategoryA(subjectNumber, runNumber)</span>
</pre><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2015a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% ptbTargetCategoryExperimentA
% 
% Category-detection task for fMRI 
% 
%% Syntax
% 
% ptbTargetCategoryExperimentA(SessionParameters)
% 
%% Description
% 
% ptbTargetCategoryExperimentA implements an fMRI experiment for a
% target-category detection task. An image is displayed with an overlaid
% fixation crosshair for a set duration on each trial, and subjects
% indicate by button press when an image from a target category appears.
% The start of each trial is locked to a keyboard input of 't,' but this
% can be switched to a set trial duration by using the debugging mode. Null
% events are double nulls by default.  The script assumes that sequence
% files have been generated for each subject on each run and that these
% files fit a specified format (see below).
%  
% Although this function implements a general-purpose experimental
% protocol, there are a number of built-in settings that users might want
% to change. This function is provided mainly as an example experiment to
% illustrate the use of ptbTools and PsychToolbox. Keep in mind that all
% functions in ptbTools are in development and have not been tested. If you
% use this or any other ptbTools functions in your experiment, make sure to
% run validation tests to ensure that timing and accuracy measures are
% correct.
% 
% * SessionParameters.subjectNumber     - subject number (e.g., 1)
% * SessionParameters.runNumber     - run number (e.g., 1)
% * SessionParameters.isDebuggingRun    - logical value indicating whether
% this is a debugging run. 1 indicates debugging and uses timed trials (of
% length cTrialDuration). 0 indicates a real experiment and time-locks the
% start of each trial to a 't' keyboard input.
% * SessionParameters.isTransparentDisplay   - logical value indicating
% whether the display should be made semi-transparent, which can be
% helpfulf during debugging. 1 indicates a semi-transparent display. 0
% indicates a real experiment and makes the dispay opaque. Transparency
% should only be used during debugging.
% * SessionParameters.directorySequences    - directory containg subject-
% and run-specific sequences. The file names should have the following
% format: 'subj001run001sequence.mat.' It is assumed that this file
% contains a SequenceInfo structure with the following fields:
% 
% <html>
% <ul>
% <ul style="list-style-type:circle">
% <li>SequenceInfo.stimulusSequence   - a cell array of stimulus file names
% for each trial, with 'null' entries for null trials</li>
% <li>SequenceInfo.conditionSequence  - a cell array of of condition names,
% which is used in selecting the stimulus-image directory and in
% calculating accuracy</li>
% <li>SequenceInfo.isTimeZero     - a sequence of logical values with a 1
% indicating the time-zero trial. This trial is used as the reference point
% when computing relative onset times. It should corresponds to the onset
% of the first scan that you will model after removing dummy or start-up
% scans.</li>
% </ul>
% </ul>
% </html>
% 
% * SessionParameters.StimulusDirectories   - this is the
% StimulusDirectories structure that will be passed to
% <file:ptbFullfileByCondtion.html ptbFullfileByCondtion>
% * SessionParameters.directoryOutput   - directory that the experiment
% data will be saved to
% * SessionParameters.ResponseParameters   - this is the ResponseParameters
% structure that will be passed to <file:ptbResponseAccuracy.html
% ptbResponseAccuracy>
% * SessionParameters.Timing    - a structure of timing information that
% must contain the following fields:
% 
% <html>
% <ul>
% <ul style="list-style-type:circle">
% <li>Timing.cStimulusDuration    - amount of time (in seconds) that the
% stimulus will be displayed</li>
% <li>Timing.cTrialDuration    - amount of time (in seconds) per trial to use
% in debugging mode</li>
% </ul>
% </ul>
% </html>
% 
% * SessionParameters.imageSize 	- size at which the stimulus images
% will be displayed. Note that if the actual images do not match this, they
% will be resized
% * SessionParameters.instructions 	- instructions that will be displayed
% at the start of the experiment (before the the first 't' input)
% 
% A data file is saved to the output directory with the following format:
% subj001run001.mat. It is important to note that the relative onset
% times in this file are calculated relative to a user specified time-zero
% trial, which is assigned in the isTimeZero field of the SequenceInfo
% structure. Raw time stamps are also provided so that onset times can be
% recalculated in the event that the time-zero reference point needs to be
% changed. This file contains a ScanData structure with the following
% fields.
% 
% * ScanData.GeneralInfo.date   - date that experiment was run
% * ScanData.GeneralInfo.computer   - computer that expriment was run on
% * ScanData.GeneralInfo.subject    - subject name (e.g., 'subj001')
% * ScanData.GeneralInfo.run    - run name (e.g., 'run001')
% * ScanData.GeneralInfo.SessionParameters  - input parameters passed to
% this function
% * ScanData.Sequence   - the SequenceInfo structure loaded in for this
% subject and run
% * ScanData.Timing.TrialOnset.raw 	- time stamp of trial onset
% * ScanData.Timing.TrialOnset.relative 	- trial onset time relative to
% the time-zero reference point
% * ScanData.Timing.StimulusOnset.raw 	- time stamp of stimulus onset
% (this could lag behind the trial onset if the computer is slow or if the
% stimulus files a very large)
% * ScanData.Timing.StimulusOnset.relative 	- stimulus onset time relative
% to the time-zero reference point
% * ScanData.Timing.StimulusOffset.raw 	- time stamp of stimulus offset
% * ScanData.Timing.InterStimulusIntervalOnsets.raw 	- time stamp of ISI
% onset
% * ScanData.Timing.timeZeroTrial 	- trial number of the time-zero trial
% used as the zero reference point
% * ScanData.ResponseData.responses     - subject's responses
% * ScanData.ResponseData.accuracy     - subject's accuracy
% * ScanData.ResponseData.ReactionTime.raw     - time stamps of subject's
% responses
% * ScanData.ResponseData.ReactionTime.relative     - subject's reaction
% time relative to stimulus onset
%
%% Example
% 
%   % Import default settings
%   setPtbParameters_TargetCategory_v001; 
%   isDebuggingRun = PtbParameters.isDebuggingRun;
%   isTransparentDisplay = PtbParameters.isTransparentDisplay;
%   
%   % Directories
%   directorySequences = PtbParameters.directorySequences;
%   directoryStimuli = PtbParameters.directoryStimuli;
%   directoryOutput = PtbParameters.directoryOutput;
%   directoryExperimental = fullfile(directoryStimuli, 'pathways');
%   directoryTarget = fullfile(directoryStimuli, 'target');
%   directoryFiller = fullfile(directoryStimuli, 'filler');
%   directoryStartUp = fullfile(directoryStimuli, 'startUp');
%   
%   % Add ptbTools paths
%   addpath(PtbParameters.directoryPtbTools);
%   
%   % Condition labels and associated directories (this will be passed to
%   % ptbFullfileByCondtion)
%   StimulusDirectories.StartUp.conditions = {'startUp'};
%   StimulusDirectories.StartUp.directory = directoryStartUp;
%   StimulusDirectories.Experimental.conditions = {'pathways', 'targetCarryover', 'fillerCarryover', 'nullCarryover'};
%   StimulusDirectories.Experimental.directory = directoryExperimental;
%   StimulusDirectories.Target.conditions = {'target'};
%   StimulusDirectories.Target.directory = directoryTarget;
%   StimulusDirectories.Filler.conditions = {'filler'};
%   StimulusDirectories.Filler.directory = directoryFiller;
%   StimulusDirectories.Null.conditions = {'null'};
%   StimulusDirectories.Null.directory = [];
%   StimulusDirectories.WrapUp.conditions = {'wrapUp'};
%   StimulusDirectories.WrapUp.directory = [];
%   
%   % Response keys and conditions
%   if isDebuggingRun
%       rightKey = 'm';
%   else
%       rightKey = 'r';
%   end
%   responseKeys = {rightKey};
%   rightConditionLabel = 'target';
%   ResponseParameters.responseKeys = responseKeys;
%   ResponseParameters.rightKey = rightKey;
%   ResponseParameters.rightConditionLabel = rightConditionLabel;
%   ResponseParameters.leftKey = nan;
%   ResponseParameters.leftConditionLabel = nan;
%   
%   % Timing (in seconds)
%   Timing.cStimulusDuration = 1.5;  % seconds
%   Timing.cTrialDuration = 2;  % for debugging mode
%   
%   % Screen size, which is used for sizing the stimulus
%   hScreen = ptbScreenSettings;  % screen settings, including a standard gray background
%   screenSize = Screen('Rect', hScreen); 
%   screenHeight = screenSize(3);
%   
%   % Image size
%   cImageDownsize = PtbParameters.cImageDownsize;
%   imageExtension = PtbParameters.imageExtension;
%   directoryExampleImage = fullfile(directoryStimuli, 'pathways');
%   searchInput = fullfile(directoryExampleImage, ['*' imageExtension]);
%   searchResults = dir(searchInput);
%   exampleImageFile = fullfile(directoryExampleImage, searchResults(1).name);
%   exampleImage = imread(exampleImageFile);
%   exampleImageSize = size(exampleImage);
%   exampleImageSize = exampleImageSize(1 : 2);
%   exampleImageHeight = exampleImageSize(1);
%   largestPossibleScaling = screenHeight / exampleImageHeight;
%   cImageScale = cImageDownsize * largestPossibleScaling;
%   imageSize = exampleImageSize * cImageScale;
%   clear exampleImage searchInput searchResults directoryExampleImage;
%   
%   % Instructions
%   instructions = [
%       'Please fixate on the crosshair and pay attention to each scene.\n\n'...
%       'Press the right button if the scene is a target scene.\n\n'...
%       'Get ready!\n\n'
%       ]; 
% 
%   % Run this session
%   SessionParameters.subjectNumber = subjectNumber;
%   SessionParameters.runNumber = runNumber;
%   SessionParameters.isDebuggingRun = isDebuggingRun;
%   SessionParameters.isTransparentDisplay = isTransparentDisplay;
%   SessionParameters.directorySequences = directorySequences;
%   SessionParameters.StimulusDirectories = StimulusDirectories;
%   SessionParameters.directoryOutput = directoryOutput;
%   SessionParameters.ResponseParameters = ResponseParameters;
%   SessionParameters.Timing = Timing;
%   SessionParameters.imageSize = imageSize;
%   SessionParameters.instructions = instructions;
%   ptbTargetCategoryExperimentA(SessionParameters)
% 
%% See also
%
% * <file:ptbRunExperiment.html ptbRunExperiment>
% * <file:ptbFullfileByCondtion.html ptbFullfileByCondtion>
% * <file:ptbScreenSettings.html ptbScreenSettings>
% * <file:ptbInstructions.html ptbInstructions>
% * <file:ptbWaitForT.html ptbWaitForT>
% * <file:ptbKbQueueCreate.html ptbKbQueueCreate>
% * <file:ptbRelativeToTimeZero.html ptbRelativeToTimeZero>
% * <file:ptbGetResponse.html ptbGetResponse>
% * <file:ptbResponseAccuracy.html ptbResponseAccuracy>
% * <file:ptbCrosshair.html ptbCrosshair>
% * <file:ptbEndRun.html ptbEndRun> 
% 
% Michael F. Bonner | University of Pennsylvania | <http://www.michaelfbonner.com> 



%% Function

function ptbTargetCategoryExperimentA(SessionParameters)


%% Assign variables

% SessionParameters inputs 
subjectNumber = SessionParameters.subjectNumber;
runNumber = SessionParameters.runNumber;
isDebuggingRun = SessionParameters.isDebuggingRun;
isTransparentDisplay = SessionParameters.isTransparentDisplay;
directorySequences = SessionParameters.directorySequences;
directoryOutput = SessionParameters.directoryOutput;
StimulusDirectories = SessionParameters.StimulusDirectories;
ResponseParameters = SessionParameters.ResponseParameters;
Timing = SessionParameters.Timing;
imageSize = SessionParameters.imageSize;
instructions = SessionParameters.instructions;
PtbParameters = SessionParameters.PtbParameters;

% More input parsing
responseKeys = ResponseParameters.responseKeys;
cStimulusDuration = Timing.cStimulusDuration;
cTrialDuration = Timing.cTrialDuration;

% Subject and run
subjectName = ['subj' num2str(subjectNumber, '%03d')];
runName = ['run' num2str(runNumber, '%03d')];

% Output data file
if ~exist(directoryOutput, 'dir');
    mkdir(directoryOutput);
end
ScanDataFileName = [subjectName runName 'data.mat'];
ScanDataFullFile = fullfile(directoryOutput, ScanDataFileName);

% Check that data has not already been generated for this subject and run
if exist(ScanDataFullFile, 'file')
    error('An output file has already been generated for this subject and run');
end

% Stimulus directories
FullfileParameters.StimulusDirectories = StimulusDirectories;

% Delay before displaying stimulus in debuggind mode
cOnsetDelay = 0;  



%% Load scan sequence
% 
% sequenceFullFile contains the SequenceInfo with the following fields:
% 
% * SequenceInfo.conditionSequence    - sequence of condition labels for
% this run
% * SequenceInfo.stimulusSequence   - sequence of stimulus files for this
% run
% * SequenceInfo.isTimeZero   - sequence of logical values in which the only
% 'true' entry is the first trial after the startUp trials (this represents
% time t=0 if the startUp scans are removed before analyzing the fMRI data)

sequenceFileName = [subjectName runName 'sequence.mat'];
sequenceFullFile = fullfile(directorySequences, sequenceFileName);
load(sequenceFullFile);  % Loads SequenceInfo (described at the top of this code section)
stimulusSequence = SequenceInfo.stimulusSequence;
conditionSequence = SequenceInfo.conditionSequence;
isTimeZeroValues = SequenceInfo.isTimeZero;
timeZeroTrial = find(isTimeZeroValues);



%% Set experiment parameters

% Make display transparent when debugging
if isTransparentDisplay
    screenOpacity = 0.75;
    PsychDebugWindowConfiguration(0, screenOpacity);  % note that time-stamping will be inaccurate in this mode
end

% Reseed the random-number generator
rand('state', sum(100 * clock));

% PsychToolbox settings
hScreen = ptbScreenSettings;  % screen settings, including a standard gray background
AssertOpenGL;  % Check for OpenGL compatibility, abort otherwise
KbName('UnifyKeyNames'); % Make sure keyboard mapping is the same on all supported operating systems: Apple MacOS/X, MS-Windows and GNU/Linux:

% Position for center of screen
screenSize = Screen('Rect', hScreen); 
screenWidth = screenSize(4);
screenHeight = screenSize(3);
centerWidth = screenWidth / 2;
centerHeight = screenHeight / 2; 

% Crosshair
CrosshairParameters.color = [50 50 50];
CrosshairParameters.width = 20;
CrosshairParameters.height = 20;
CrosshairParameters.thickness = 6;
CrosshairParameters.screenCenterWidth = centerWidth;
CrosshairParameters.screenCenterHeight = centerHeight;
CrosshairParameters.screenHandle = hScreen;

% Text properties
Screen('TextSize', hScreen, 32);  
Screen('TextFont', hScreen, 'Arial');

% Do dummy calls to make sure functions are loaded and ready when we need them - without delays:
WaitSecs(0.1);
GetSecs;



%% Display instructions

InstructionsParameters.instructions = instructions;
InstructionsParameters.screenHandle = hScreen;
InstructionsParameters.textColor = WhiteIndex(hScreen);
ptbInstructions(InstructionsParameters);

% If in debugging moded, wait trial duration, instead of waiting for for
% the first 't' below
if isDebuggingRun
    WaitSecs(cTrialDuration);  
end



%% Pre-allocate output variables
% 
% Notes:
%
% * Relative trial times are calculated relative to the 'isTimeZero' trial
% * Relative reaction times are calculated relative to the stimulus onset

% Get number of events in loop
nTrials = length(stimulusSequence);

% Trial timing
Timing.TrialOnset.raw = nan(nTrials, 1, 'single');
Timing.TrialOnset.relative = nan(nTrials, 1, 'single');
Timing.StimulusOnset.raw = nan(nTrials, 1, 'single');
Timing.StimulusOnset.relative = nan(nTrials, 1, 'single');
Timing.StimulusOffset.raw = nan(nTrials, 1, 'single');
Timing.InterStimulusIntervalOnsets.raw = nan(nTrials, 1, 'single');
Timing.timeZeroTrial = timeZeroTrial;

% Response data
ResponseData.responses = cell(nTrials, 1);
ResponseData.accuracy = nan(nTrials, 1, 'single');
ResponseData.ReactionTime.raw = nan(nTrials, 1, 'single');
ResponseData.ReactionTime.relative = nan(nTrials, 1, 'single');



%% Present stimuli

timeZero = [];
for iTrials = 1 : nTrials

    % Check for time-zero trial
    isTimeZero = iTrials == timeZeroTrial;
    
    % Condition and stimulus information
    thisCondition = conditionSequence{iTrials};
    thisStimulusFile = stimulusSequence{iTrials};
    FullfileParameters.thisCondition = thisCondition;
    FullfileParameters.thisStimulusFile = thisStimulusFile;
    thisStimulusFullFile = ptbFullfileByCondtion(FullfileParameters);

    % Condition-specific routines
    if strcmp(thisCondition, 'null')  
        
        % Double null events
        
        % First null
        WaitParameters.isDebuggingRun = isDebuggingRun;
        WaitParameters.isTimeZero = isTimeZero;
        WaitParameters.timeZero = timeZero;
        WaitParameters.cTrialDuration = cTrialDuration;  % used only in debugging mode
        WaitOutput = ptbWaitForT(WaitParameters);
        timeZero = WaitOutput.timeZero;
        thisTrialOnset = WaitOutput.thisTrialOnset;
        thisRelativeTrialOnset = WaitOutput.thisRelativeTrialOnset;
        
        % Second null
        WaitOutput = ptbWaitForT(WaitParameters);
        thisIsiOnset = WaitOutput.thisTrialOnset;
        
        % Trial timing
        Timing.TrialOnset.raw(iTrials) = thisTrialOnset;
        Timing.TrialOnset.relative(iTrials) = thisRelativeTrialOnset;
        Timing.InterStimulusIntervalOnsets.raw(iTrials) = thisIsiOnset;
 
    elseif strcmp(thisCondition, 'wrapUp')  
        
        % Wrap-up trials are single null events
        
        % Null
        WaitParameters.isDebuggingRun = isDebuggingRun;
        WaitParameters.isTimeZero = isTimeZero;
        WaitParameters.timeZero = timeZero;
        WaitParameters.cTrialDuration = cTrialDuration;  % used only in debugging mode
        WaitOutput = ptbWaitForT(WaitParameters);
        timeZero = WaitOutput.timeZero;
        thisTrialOnset = WaitOutput.thisTrialOnset;
        thisRelativeTrialOnset = WaitOutput.thisRelativeTrialOnset;
        
        % Trial timing
        Timing.TrialOnset.raw(iTrials) = thisTrialOnset;
        Timing.TrialOnset.relative(iTrials) = thisRelativeTrialOnset;
        
    else
        
        % Stimulus trials: 
        % * startUp
        % * pathways
        % * target
        % * filler
        % * targetCarryover
        % * fillerCarryover
        % * nullCarryover
        
        % Load stimulus image
        thisImage = imread(thisStimulusFullFile);
        thisImage = imresize(thisImage, imageSize);
        thisImageScreenTexture = Screen('MakeTexture', hScreen, thisImage);
        Screen('DrawTexture', hScreen, thisImageScreenTexture);  % Draw texture image to backbuffer.
        
        % Load crosshair on top of image
        ptbCrosshair(CrosshairParameters);
        
        % Wait for 't'
        WaitParameters.isDebuggingRun = isDebuggingRun;
        WaitParameters.isTimeZero = isTimeZero;
        WaitParameters.timeZero = timeZero;
        WaitParameters.cTrialDuration = cOnsetDelay;  % debugging mode: zero delay at this point
        WaitOutput = ptbWaitForT(WaitParameters);
        timeZero = WaitOutput.timeZero;
        thisTrialOnset = WaitOutput.thisTrialOnset;
        thisRelativeTrialOnset = WaitOutput.thisRelativeTrialOnset;

        % Create KbQueue for responses
        ptbKbQueueCreate(responseKeys)
        KbQueueFlush(); % removes all keyboard presses
        
        % Display stimulus
        [~, thisStimulusOnset] = Screen('Flip', hScreen);  
        thisRelativeStimulusOnset = ptbRelativeToTimeZero(thisStimulusOnset, timeZero);
        
        % Get key response while stimulus is up 
        [thisResponseKey, thisRawReactionTime, thisRelativeReactionTime] = ptbGetResponse(thisStimulusOnset, cStimulusDuration);

        % Compute accuracy
        thisTrialAccuracy = ptbResponseAccuracy(thisResponseKey, thisCondition, ResponseParameters);

        % Display crosshair
        Screen('Close');
        ptbCrosshair(CrosshairParameters);
        [~, thisStimulusOffset] = Screen('Flip', hScreen);

        % Interstimulus interval (one 't')
        IntervalParameters.thisTrialOnset = thisTrialOnset;
        IntervalParameters.isDebuggingRun = isDebuggingRun;
        IntervalParameters.isTimeZero = isTimeZero;
        IntervalParameters.timeZero = timeZero;
        IntervalParameters.cTrialDuration = cTrialDuration;  % used only in debugging mode
        IntervalOutput = ptbInterStimulusInterval(IntervalParameters);
        thisIsiOnset = IntervalOutput.WaitOutput.thisTrialOnset;

        % Trial timing
        Timing.TrialOnset.raw(iTrials) = thisTrialOnset;
        Timing.TrialOnset.relative(iTrials) = thisRelativeTrialOnset;
        Timing.StimulusOnset.raw(iTrials) = thisStimulusOnset;
        Timing.StimulusOnset.relative(iTrials) = thisRelativeStimulusOnset;
        Timing.StimulusOffset.raw(iTrials) = thisStimulusOffset;
        Timing.InterStimulusIntervalOnsets.raw(iTrials) = thisIsiOnset;
        
        % Response data
        ResponseData.responses{iTrials} = thisResponseKey;
        ResponseData.accuracy(iTrials) = thisTrialAccuracy;
        ResponseData.ReactionTime.raw(iTrials) = thisRawReactionTime;
        ResponseData.ReactionTime.relative(iTrials) = thisRelativeReactionTime;
 
    end  % if strcmp(thisCondition, 'null')
    
    Screen('Close');
    
end  % for iTrials = 1 : nTrials



%% Save data

% General experiment information
GeneralInfo.date = date;
GeneralInfo.computer = computer;
GeneralInfo.subject = subjectName;
GeneralInfo.run = runName;
GeneralInfo.SessionParameters = SessionParameters;

% Save all data
ScanData.General = GeneralInfo;
ScanData.Sequence = SequenceInfo;
ScanData.Timing = Timing;
ScanData.Responses = ResponseData;
save(ScanDataFullFile, 'ScanData'); 



%%  End session

EndRunParameters.screenHandle = hScreen;
EndRunParameters.message = 'Great job!';
EndRunParameters.textColor = WhiteIndex(hScreen);
ptbEndRun(EndRunParameters)


end  % function pwExperimentTargetCategoryA(subjectNumber, runNumber)

##### SOURCE END #####
--></body></html>